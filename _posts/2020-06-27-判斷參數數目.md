---
date: 2020-06-27 12:00:00
layout: post
title: "判斷參數數目"
subtitle: 
description: "來個簡單應用：判斷參數數目"
image: https://cdn.jsdelivr.net/gh/CWKSC/MyResources/Image/post7.jpg
optimized_image: https://cdn.jsdelivr.net/gh/CWKSC/MyResources/Image/optimized/post7_opt.jpg
category: C/C++ Macro 宏系列
tags:
  - C/C++ Macro 宏系列
  - Macro 宏
  - C
  - C++
  - C/C++
  - Programming 編程
author: CWKSC
paginate: false
---

目錄： <a href="https://cwksc.github.io/C_C++-Macro-宏系列/">C/C++ Macro 宏系列 | CWKSC's blog | 博客</a>

來個簡單應用：判斷參數數目

## ▌選取第 n 項參數的宏

首先來個選取第 n 項參數的宏

```c++
#define get1th(a1, ...) a1
#define get2th(a1, a2, ...) a2
#define get3th(a1, a2, a3, ...) a3
#define get4th(a1, a2, a3, a4, ...) a4
#define get5th(a1, a2, a3, a4, a5, ...) a5
// ... getnth(a1, a2, a3, ... , an, ...) an
```

很容易理解

```c++
get1th(a, b, c, d, e)
// a
get2th(a, b, c, d, e)
// b
get3th(a, b, c, d, e)
// c
```

由於 Visual Studio 在處理 `__VA_ARGS__` 時會視為一個整體的 Token 來處理

利用重掃描可以解決這個問題

我們製作一個新的版本專門給 VS

我們先定義中間層，也就是 [重掃描](https://cwksc.github.io/重掃描/) 那篇的那個 `expend(...)`，不過換個名字

```c++
#define midLayer(...) __VA_ARGS__  // 中間層
```

然後是針對 VS 的新版本：

```c++
#define get1thVS(...) midLayer( get1th(__VA_ARGS__) )
#define get2thVS(...) midLayer( get2th(__VA_ARGS__) )
#define get3thVS(...) midLayer( get3th(__VA_ARGS__) )
#define get4thVS(...) midLayer( get4th(__VA_ARGS__) )
#define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
// ... getnthVS(a1, a2, a3, ... , an, ...) midLayer( getnth(__VA_ARGS__) )
```

效果相同：

```c++
get3thVS(a, b, c, d, e)
// #define get3thVS(...) midLayer( get3th(__VA_ARGS__) )
midLayer( get3th(__VA_ARGS__) )
midLayer( get3th(a, b, c, d, e) )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get3th(a, b, c, d, e)
// #define get3th(a1, a2, a3, ...) a3
a3
c
```

## ▌判斷參數數目

```c++
#define parameterNum(...) get5thVS(__VA_ARGS__, 4, 3, 2, 1)
```

這裏利用到 `__VA_ARGS__` 展開時導致參數項數目改變的特性

當初學到這個的時候實在是很驚喜、意想不到

來直接看展開流程

```c++
parameterNum(a)
// #define parameterNum(...) get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(a, 4, 3, 2, 1)
// #define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(a) )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get5th(a, 4, 3, 2, 1)
// #define get5th(a1, a2, a3, a4, a5, ...) a5
a5
1
```

再來其他例子

```c++
parameterNum(a, b, c, d)
// #define parameterNum(...) get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(a, b, c, d, 4, 3, 2, 1)
// #define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(a, b, c, d) )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get5th(a, b, c, d, 4, 3, 2, 1)
// #define get5th(a1, a2, a3, a4, a5, ...) a5
a5
4
```

`__VA_ARGS__` 展開時改變了參數項數目

把原本在前面的參數項擠到後面

再配合 選取第 n 項參數的宏

就可以判斷參數數目，是不是很神奇

## ▌分辨 0 和 1 個參數數目

上面的例子可以看到， 1 個參數數目時

`parameterNum(a)` 成功展開了 1

但是，目前的 `parameterNum` 無法分辨 0 個參數數目的情況

我們來試一次

```c++
parameterNum()
// #define parameterNum(...) get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(__VA_ARGS__, 4, 3, 2, 1)
get5thVS(, 4, 3, 2, 1)
// #define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
midLayer( get5th() )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get5th(, 4, 3, 2, 1)
// #define get5th(a1, a2, a3, a4, a5, ...) a5
a5
1
```

`parameterNum()` 和 `parameterNum(a)` 都是展開了 1

我們預期 `parameterNum()` 會展開 0

爲了解決這個問題，會利用 [可變參數宏 __VA_ARGS__]() 提到的 去除額外的逗號

把 `__VA_ARGS__` 改為 `## __ VA_ARGS__` ，編譯器會自動把前面的逗號去除

因為某些原因，我們把這種行為封裝成一個宏函數

```c++
#define eatComma(...) ,##__VA_ARGS__  // 吃掉逗號
```

然後

```c++
#define parameterNum(...) get5thVS( eatComma(__VA_ARGS__), 3, 2, 1, 0)
```

試一次

```c++
parameterNum()
// #define parameterNum(...) get5thVS( eatComma(__VA_ARGS__), 3, 2, 1, 0)
get5thVS( eatComma(__VA_ARGS__), 3, 2, 1, 0)
get5thVS( eatComma(), 3, 2, 1, 0)
// #define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(eatComma(), 3, 2, 1, 0) )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get5th(eatComma(), 3, 2, 1, 0)
// #define get5th(a1, a2, a3, a4, a5, ...) a5
a5
0
```

試 `parameterNum(a)`

```c++
parameterNum(a)
// #define parameterNum(...) get5thVS( eatComma(__VA_ARGS__), 3, 2, 1, 0)
get5thVS( eatComma(__VA_ARGS__), 3, 2, 1, 0)
get5thVS( eatComma(a), 3, 2, 1, 0)
// #define get5thVS(...) midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(__VA_ARGS__) )
midLayer( get5th(eatComma(a), 3, 2, 1, 0) )
// #define midLayer(...) __VA_ARGS__
__VA_ARGS__
get5th(eatComma(a), 3, 2, 1, 0)
// #define get5th(a1, a2, a3, a4, a5, ...) a5
a5
0
```

## ▌判斷參數數目的上限

`parameterNum()` 是依賴 `get5thVS()` 來做的

`get5thVS()` 確定了 `parameterNum()` 可判斷參數數目的上限

`get5thVS()` 最多可判斷 4 個，`get7thVS()` 可判斷 6 個 . . . . . . 

`getnthVS()` 可判斷`n-1` 個

我個人會寫好十個左右的 `getnthVS()` ，`get1thVS() ~ get10thVS()`，

正常夠用的了，如果 9 個可判斷參數數目都不夠用的話 ...

該反省一下這個函數的設計，會不會過於復雜

## ▌結語

爲了以免一直說理論

就來了個簡單的應用：判斷參數數目

如果知道可變參數函數的話

你會發現這個宏配合可變參數函數會很有用